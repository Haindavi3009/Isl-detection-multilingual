<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Indian Sign Language Detection - TTS Only v3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #6b8e23, #9acd32);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .main-content {
            padding: 40px;
        }

        .text-to-sign-section {
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(85, 107, 47, 0.15);
        }

        .text-to-sign-section h2 {
            text-align: center;
            color: #556b2f;
            margin-bottom: 25px;
            font-size: 24px;
        }

        .input-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        #textInput {
            flex: 1;
            min-width: 200px;
            padding: 15px 20px;
            font-size: 16px;
            border: 2px solid #9acd32;
            border-radius: 25px;
            outline: none;
            transition: all 0.3s ease;
        }

        #textInput:focus {
            border-color: #6b8e23;
            box-shadow: 0 0 15px rgba(154, 205, 50, 0.3);
        }

        button {
            padding: 15px 25px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .voice-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            min-width: 60px;
        }

        .voice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .voice-btn.listening {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        #convertToSignBtn {
            background: linear-gradient(135deg, #9acd32, #6b8e23);
            color: white;
        }

        #convertToSignBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(154, 205, 50, 0.4);
        }

        .sign-display {
            text-align: center;
            margin-top: 30px;
        }

        #signImage {
            max-width: 300px;
            max-height: 300px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        #signText {
            font-size: 2rem;
            color: #6b8e23;
            margin: 20px 0;
            font-weight: bold;
        }

        .language-selector {
            margin: 20px 0;
            text-align: center;
        }

        .language-selector select {
            padding: 10px 15px;
            font-size: 16px;
            border: 2px solid #9acd32;
            border-radius: 10px;
            background: white;
        }

        .status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 15px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Camera Detection Styles */
        .detection-section {
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(85, 107, 47, 0.15);
        }

        .detection-section h2 {
            text-align: center;
            color: #556b2f;
            margin-bottom: 25px;
            font-size: 24px;
        }

        .camera-container {
            text-align: center;
            margin-bottom: 20px;
        }

        #video {
            max-width: 100%;
            width: 640px;
            height: 480px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .controls button {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #startCamera {
            background: linear-gradient(135deg, #6b8e23, #9acd32);
            color: white;
        }

        #predictSign {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        #predictSign:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .options {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .options label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #556b2f;
        }

        .result {
            text-align: center;
            margin: 40px 0;
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(85, 107, 47, 0.15);
        }

        .result h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #556b2f;
            font-weight: 600;
        }

        .sign {
            font-size: 4rem;
            font-weight: bold;
            margin: 20px 0;
            color: #6b8e23;
            text-shadow: 2px 2px 8px rgba(85, 107, 47, 0.2);
        }

        .confidence {
            font-size: 16px;
            color: #556b2f;
            font-weight: 500;
            background: rgba(154, 205, 50, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ¤Ÿ Indian Sign Language Detection</h1>
            <p>Convert text to sign language with voice input support</p>
            <!-- Quick TTS Test Button -->
            <button onclick="quickTTSTest()" style="background:#FF6B6B; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin:10px;">
                ðŸ”Š Quick TTS Test (Click Me!)
            </button>
        </div>

        <div class="main-content">
            <!-- Camera-based Sign Detection Section -->
            <div class="detection-section">
                <h2>ðŸ¤Ÿ Sign Detection from Camera</h2>
                <div class="camera-container">
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="canvas" style="display:none;"></canvas>
                </div>
                
                <div class="controls">
                    <button id="startCamera">Start Camera</button>
                    <button id="predictSign" disabled>Predict Sign</button>
                </div>
                
                <div class="options">
                    <label>
                        <input type="checkbox" id="voiceOutput" checked> 
                        <span>ðŸ”Š Voice Output</span>
                    </label>
                    <label>
                        Language: 
                        <select id="languageSelect">
                            <option value="en-US">English</option>
                            <option value="hi-IN">Hindi</option>
                            <option value="te-IN">Telugu</option>
                            <option value="ml-IN">Malayalam</option>
                            <option value="ta-IN">Tamil</option>
                            <option value="kn-IN">Kannada</option>
                            <option value="bn-IN">Bengali</option>
                            <option value="mr-IN">Marathi</option>
                        </select>
                    </label>
                    <button id="testVoice" style="background: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 5px; margin-left: 10px;">ðŸ”Š Test Voice</button>
                </div>
                
                <div class="result">
                    <h2>Detected Sign</h2>
                    <div class="sign" id="predictedSign">-</div>
                    <div class="confidence" id="confidence">-</div>
                </div>
                
                <div id="status" class="status"></div>
            </div>

            <!-- Text to Sign Section -->
            <div class="text-to-sign-section">
                <h2>Text to Sign</h2>
                
                <div class="language-selector">
                    <label for="textLanguageSelect">Language: </label>
                    <select id="textLanguageSelect">
                        <option value="en-US">English</option>
                        <option value="hi-IN">Hindi</option>
                        <option value="te-IN">Telugu</option>
                        <option value="ml-IN">Malayalam</option>
                        <option value="ta-IN">Tamil</option>
                        <option value="kn-IN">Kannada</option>
                        <option value="bn-IN">Bengali</option>
                        <option value="mr-IN">Marathi</option>
                    </select>
                </div>
                
                <div class="input-controls">
                    <input type="text" id="textInput" placeholder="type any alphabet or number from 1-9" maxlength="50">
                    <button id="convertToSignBtn">Show Sign</button>
                </div>

                <div class="sign-display">
                    <div id="signImageContainer">
                        <img id="signImage" style="display:none;">
                        <div id="signText"></div>
                    </div>
                </div>

                <div id="status" class="status" style="display:none;"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // VERSION: TTS_ONLY_V3 - NO BROWSER SPEECH
        // Last Updated: 2025-10-04
        // ============================================
        console.log('ðŸš€ LOADING ISL APP - VERSION: TTS_ONLY_V3');
        console.log('âš ï¸ This version uses ONLY Google TTS - NO browser speech!');
        
        // Quick TTS Test Function
        function quickTTSTest() {
            console.log('ðŸ§ª Quick TTS Test Started');
            const ttsUrl = '/tts?text=Hello&lang=en';
            console.log('URL:', ttsUrl);
            
            const audio = new Audio(ttsUrl);
            
            audio.addEventListener('canplay', () => {
                console.log('âœ… Audio ready');
            });
            
            audio.addEventListener('play', () => {
                console.log('â–¶ï¸ Playing');
            });
            
            audio.addEventListener('error', (e) => {
                console.error('âŒ Error:', audio.error);
                alert('Error: ' + (audio.error?.message || 'Unknown'));
            });
            
            audio.play()
                .then(() => console.log('âœ… Play() succeeded!'))
                .catch(err => {
                    console.error('âŒ Play() failed:', err);
                    alert('Play failed: ' + err.message);
                });
        }
        
        // Camera-based Sign Detection Class
        class ISLDetector {
            constructor() {
                console.log('ðŸ“± Initializing ISL Detector...');
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.startCameraBtn = document.getElementById('startCamera');
                this.predictBtn = document.getElementById('predictSign');
                this.predictedSign = document.getElementById('predictedSign');
                this.confidence = document.getElementById('confidence');
                this.voiceCheckbox = document.getElementById('voiceOutput');
                this.languageSelect = document.getElementById('languageSelect');
                this.testVoiceBtn = document.getElementById('testVoice');
                this.status = document.getElementById('status');
                
                this.isProcessing = false;
                this.stream = null;
                
                this.initializeEventListeners();
            }
            
            initializeEventListeners() {
                this.startCameraBtn.addEventListener('click', () => this.toggleCamera());
                this.predictBtn.addEventListener('click', () => this.predictSign());
                this.testVoiceBtn.addEventListener('click', () => this.testVoice());
            }
            
            async toggleCamera() {
                if (this.stream) {
                    this.stopCamera();
                } else {
                    await this.startCamera();
                }
            }
            
            async startCamera() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { width: 640, height: 480 } 
                    });
                    this.video.srcObject = this.stream;
                    
                    this.startCameraBtn.textContent = 'Stop Camera';
                    this.predictBtn.disabled = false;
                    this.showStatus('Camera started successfully', 'success');
                } catch (error) {
                    this.showStatus('Error accessing camera: ' + error.message, 'error');
                }
            }
            
            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                    this.video.srcObject = null;
                    
                    this.startCameraBtn.textContent = 'Start Camera';
                    this.predictBtn.disabled = true;
                    this.showStatus('Camera stopped', 'success');
                }
            }
            
            async predictSign() {
                if (this.isProcessing) return;
                
                this.isProcessing = true;
                this.predictBtn.disabled = true;
                this.showStatus('Capturing and analyzing...', 'success');
                
                // Capture frame from video
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;
                this.ctx.drawImage(this.video, 0, 0);
                
                // Convert to base64
                const imageData = this.canvas.toDataURL('image/jpeg', 0.8);
                
                // Send to backend
                fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image: imageData,
                        language: this.languageSelect.value
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Backend response:', data); // Debug log
                    if (data.success) {
                        // Display both localized text and English sign
                        let displayText;
                        if (data.localized_text && data.localized_text !== data.sign) {
                            // Show localized text with English in parentheses
                            displayText = `${data.localized_text} (${data.sign})`;
                        } else {
                            // If no localization or same as English, just show the sign
                            displayText = data.sign;
                        }
                        this.predictedSign.textContent = displayText;
                        this.confidence.textContent = `Confidence: ${(data.confidence * 100).toFixed(2)}%`;
                        
                        if (this.voiceCheckbox.checked) {
                            // Use localized text if available, otherwise use the sign itself
                            const textToSpeak = data.localized_text || data.sign;
                            console.log('Text to speak:', textToSpeak, 'from localized_text:', data.localized_text, 'sign:', data.sign);
                            this.speak(textToSpeak);
                        }
                        
                        this.showStatus('Prediction complete', 'success');
                    } else {
                        this.showStatus(`Error: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    this.showStatus(`Error: ${error.message}`, 'error');
                })
                .finally(() => {
                    this.isProcessing = false;
                    this.predictBtn.disabled = false;
                });
            }
            
            // Improved speak method - now receives already localized text from backend
            speak(text) {
                const selectedLanguage = this.languageSelect.value;
                console.log('ðŸ”Š ISL Detector speak() called with:', text, 'Language:', selectedLanguage);
                
                // ONLY use Google TTS - no browser speech fallback
                this.playTTS(text, selectedLanguage);
            }
            
            playTTS(text, language) {
                console.log('ðŸŽµ Starting TTS playback for:', text);
                
                // Extract short language code (e.g., 'en' from 'en-US')
                const shortLang = language.split('-')[0];
                
                // Build the TTS URL
                const ttsUrl = `/tts?text=${encodeURIComponent(text)}&lang=${shortLang}`;
                console.log('ðŸ“ TTS URL:', ttsUrl);
                
                // Create NEW audio element every time (more reliable)
                const audio = new Audio(ttsUrl);
                
                // Add all event listeners for debugging
                audio.addEventListener('loadstart', () => {
                    console.log('ðŸ“¥ Audio loading started');
                });
                
                audio.addEventListener('loadedmetadata', () => {
                    console.log('âœ… Audio metadata loaded, duration:', audio.duration);
                });
                
                audio.addEventListener('canplay', () => {
                    console.log('âœ… Audio can play now');
                });
                
                audio.addEventListener('play', () => {
                    console.log('â–¶ï¸ Audio playback STARTED for:', text);
                });
                
                audio.addEventListener('playing', () => {
                    console.log('â–¶ï¸ Audio is PLAYING');
                });
                
                audio.addEventListener('ended', () => {
                    console.log('â¹ï¸ Audio playback ENDED');
                });
                
                audio.addEventListener('error', (e) => {
                    console.error('âŒ Audio ERROR:', {
                        error: audio.error,
                        code: audio.error?.code,
                        message: audio.error?.message,
                        networkState: audio.networkState,
                        readyState: audio.readyState
                    });
                    
                    // Show alert with error
                    alert('TTS Error: ' + (audio.error?.message || 'Unknown error') + 
                          '\n\nPlease check:\n1. Server is running\n2. Try: ' + ttsUrl);
                });
                
                // Try to play
                console.log('ðŸš€ Attempting to play audio...');
                audio.play()
                    .then(() => {
                        console.log('âœ… âœ… âœ… PLAY SUCCEEDED! Audio should be playing now âœ… âœ… âœ…');
                    })
                    .catch(error => {
                        console.error('âŒ PLAY FAILED:', {
                            name: error.name,
                            message: error.message
                        });
                        
                        // Show user-friendly error
                        if (error.name === 'NotAllowedError') {
                            alert('Browser blocked autoplay. Please click "Test Voice" button first to enable audio.');
                        } else if (error.name === 'NotSupportedError') {
                            alert('Audio format not supported by browser.');
                        } else {
                            alert('Could not play audio: ' + error.message);
                        }
                    });
            }
            
            testVoice() {
                const selectedLanguage = this.languageSelect.value;
                const testMessages = {
                    'en-US': 'Voice output is working correctly in English',
                    'hi-IN': 'à¤†à¤µà¤¾à¤œà¤¼ à¤†à¤‰à¤Ÿà¤ªà¥à¤Ÿ à¤¸à¤¹à¥€ à¤¤à¤°à¥€à¤•à¥‡ à¤¸à¥‡ à¤•à¤¾à¤® à¤•à¤° à¤°à¤¹à¤¾ à¤¹à¥ˆ',
                    'te-IN': 'à°µà°¾à°¯à°¿à°¸à± à°…à°µà±à°Ÿà±â€Œà°ªà±à°Ÿà± à°¸à°°à°¿à°—à±à°—à°¾ à°ªà°¨à°¿ à°šà±‡à°¸à±à°¤à±‹à°‚à°¦à°¿',
                    'ml-IN': 'à´µàµ‹à´¯àµà´¸àµ à´”à´Ÿàµà´Ÿàµà´ªàµà´Ÿàµà´Ÿàµ à´¶à´°à´¿à´¯à´¾à´¯à´¿ à´ªàµà´°à´µàµ¼à´¤àµà´¤à´¿à´•àµà´•àµà´¨àµà´¨àµ',
                    'ta-IN': 'à®•à¯à®°à®²à¯ à®µà¯†à®³à®¿à®¯à¯€à®Ÿà¯ à®šà®°à®¿à®¯à®¾à®• à®šà¯†à®¯à®²à¯à®ªà®Ÿà¯à®•à®¿à®±à®¤à¯',
                    'kn-IN': 'à²µà²¾à²¯à³à²¸à³ à²”à²Ÿà³â€Œà²ªà³à²Ÿà³ à²¸à²°à²¿à²¯à²¾à²—à²¿ à²•à³†à²²à²¸ à²®à²¾à²¡à³à²¤à³à²¤à²¿à²¦à³†',
                    'bn-IN': 'à¦­à¦¯à¦¼à§‡à¦¸ à¦†à¦‰à¦Ÿà¦ªà§à¦Ÿ à¦¸à¦ à¦¿à¦•à¦­à¦¾à¦¬à§‡ à¦•à¦¾à¦œ à¦•à¦°à¦›à§‡',
                    'mr-IN': 'à¤†à¤µà¤¾à¤œ à¤†à¤‰à¤Ÿà¤ªà¥à¤Ÿ à¤¯à¥‹à¤—à¥à¤¯à¤°à¤¿à¤¤à¥à¤¯à¤¾ à¤•à¤¾à¤°à¥à¤¯ à¤•à¤°à¤¤ à¤†à¤¹à¥‡'
                };
                
                const testMessage = testMessages[selectedLanguage] || testMessages['en-US'];
                console.log('Testing voice output:', testMessage, 'Language:', selectedLanguage);
                this.speak(testMessage);
            }
            
            showStatus(message, type) {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
                this.status.style.display = 'block';
                
                setTimeout(() => {
                    this.status.innerHTML = '';
                }, 5000);
            }
        }

        // Text to Sign Converter Class
        class TextToSignConverter {
            constructor() {
                this.textInput = document.getElementById('textInput');
                this.convertBtn = document.getElementById('convertToSignBtn');
                this.voiceBtn = document.getElementById('voiceInputBtn');
                this.signImage = document.getElementById('signImage');
                this.signText = document.getElementById('signText');
                this.languageSelect = document.getElementById('textLanguageSelect');
                this.status = document.getElementById('status'); // Fixed: was 'textStatus', now 'status'
                
                this.isRecording = false;
                this.recognition = null;
                
                this.initializeEventListeners();
            }
            
            initializeEventListeners() {
                this.convertBtn.addEventListener('click', () => this.convertTextToSign());
                this.textInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.convertTextToSign();
                });
                this.voiceBtn.addEventListener('click', () => this.toggleVoiceInput());
            }

            showStatus(message, type = 'success') {
                if (this.status) {
                    this.status.textContent = message;
                    this.status.className = `status ${type}`;
                    this.status.style.display = 'block';
                    
                    setTimeout(() => {
                        this.status.style.display = 'none';
                    }, 3000);
                }
            }

            async toggleVoiceInput() {
                if (this.isRecording) {
                    this.stopSpeechRecognition();
                } else {
                    this.startSpeechRecognition();
                }
            }

            startSpeechRecognition() {
                try {
                    console.log('Type any alphabet or number');
                    
                    // Check for Speech Recognition API
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    
                    if (!SpeechRecognition) {
                        alert('Speech recognition not supported in this browser. Please use Chrome or Edge.');
                        return;
                    }

                    // Create recognition instance
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.maxAlternatives = 1;
                    
                    // Set language based on selection
                    const selectedLang = this.languageSelect.value;
                    this.recognition.lang = selectedLang;
                    console.log('Using language:', selectedLang);

                    this.recognition.onstart = () => {
                        console.log('ðŸŽ¤ Speech recognition started');
                        this.isRecording = true;
                        this.voiceBtn.classList.add('listening');
                        this.voiceBtn.textContent = 'ðŸ›‘';
                        this.textInput.placeholder = 'ðŸŽ¤ Listening... Speak now!';
                        this.showStatus('Listening... Say text to convert to signs', 'success');
                    };

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        const confidence = event.results[0][0].confidence;
                        
                        console.log('ðŸ“ Transcript:', transcript);
                        console.log('âœ… Confidence:', confidence);
                        
                        // Put the recognized text in the input field
                        this.textInput.value = transcript.toUpperCase();
                        this.showStatus(`Recognized: "${transcript}" (${(confidence * 100).toFixed(0)}% confident)`, 'success');
                        
                        // Automatically convert to sign
                        setTimeout(() => {
                            this.convertTextToSign();
                        }, 500);
                    };

                    this.recognition.onerror = (event) => {
                        console.error('âŒ Speech recognition error:', event.error);
                        
                        let errorMessage = 'Speech recognition error';
                        if (event.error === 'no-speech') {
                            errorMessage = 'No speech detected. Please try again.';
                        } else if (event.error === 'audio-capture') {
                            errorMessage = 'No microphone found. Please connect a microphone.';
                        } else if (event.error === 'not-allowed') {
                            errorMessage = 'Microphone permission denied. Please allow microphone access.';
                        } else {
                            errorMessage = `Error: ${event.error}`;
                        }
                        
                        this.showStatus(errorMessage, 'error');
                        this.resetVoiceButton();
                    };

                    this.recognition.onend = () => {
                        console.log('ï¿½ Speech recognition ended');
                        this.resetVoiceButton();
                    };

                    // Start recognition
                    this.recognition.start();

                } catch (error) {
                    console.error('âŒ Error starting speech recognition:', error);
                    alert('Could not start speech recognition: ' + error.message);
                    this.resetVoiceButton();
                }
            }

            stopSpeechRecognition() {
                console.log('ðŸ›‘ Stopping speech recognition...');
                
                if (this.recognition && this.isRecording) {
                    this.recognition.stop();
                }
                
                this.resetVoiceButton();
            }

            resetVoiceButton() {
                this.isRecording = false;
                this.voiceBtn.classList.remove('listening');
                this.voiceBtn.textContent = 'ðŸŽ¤';
                this.textInput.placeholder = 'Type text or use voice input';
            }

            isValidCharacter(char) {
                if (!char || char.length !== 1) return false;
                const upperChar = char.toUpperCase();
                return (upperChar >= 'A' && upperChar <= 'Z') || (char >= '1' && char <= '9');
            }

            getNumberWordSuggestion(inputWord, language) {
                const numberWords = {
                    'te-IN': {
                        'okati': '1', 'oka': '1',
                        'rendu': '2', 'renda': '2',
                        'moodu': '3', 'mudo': '3',
                        'nalugu': '4', 'nalgu': '4',
                        'aidu': '5', 'ayidu': '5',
                        'aaru': '6', 'aru': '6',
                        'eadu': '7', 'yadu': '7',
                        'enimidi': '8', 'yenimidi': '8',
                        'tommidi': '9', 'tomidi': '9'
                    },
                    'hi-IN': {
                        'ek': '1', 'à¤à¤•': '1',
                        'do': '2', 'à¤¦à¥‹': '2',
                        'teen': '3', 'à¤¤à¥€à¤¨': '3',
                        'char': '4', 'à¤šà¤¾à¤°': '4',
                        'panch': '5', 'à¤ªà¤¾à¤‚à¤š': '5',
                        'che': '6', 'à¤›à¤¹': '6',
                        'saat': '7', 'à¤¸à¤¾à¤¤': '7',
                        'aath': '8', 'à¤†à¤ ': '8',
                        'nau': '9', 'à¤¨à¥Œ': '9'
                    },
                    'en-US': {
                        'one': '1', 'two': '2', 'three': '3', 'four': '4', 'five': '5',
                        'six': '6', 'seven': '7', 'eight': '8', 'nine': '9'
                    }
                };

                if (numberWords[language] && numberWords[language][inputWord]) {
                    return numberWords[language][inputWord];
                }

                for (const lang in numberWords) {
                    if (numberWords[lang][inputWord]) {
                        return numberWords[lang][inputWord];
                    }
                }

                return null;
            }

            convertTextToSign() {
                const inputText = this.textInput.value.trim();
                if (!inputText) {
                    this.showSignText('Please enter a character');
                    return;
                }

                const currentLang = this.languageSelect.value;
                
                // Check for number word suggestions
                const suggestion = this.getNumberWordSuggestion(inputText.toLowerCase(), currentLang);
                if (suggestion) {
                    this.showSignText(`For "${inputText}", please type "${suggestion}" instead`);
                    return;
                }

                this.showSignText('Converting...');

                fetch('/text-to-sign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: inputText,
                        language: currentLang
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Received response from text-to-sign:', data);
                    if (data.success) {
                        this.displaySign(data);
                        this.showStatus('Sign displayed successfully!', 'success');
                        // Voice output removed - using voice INPUT instead
                    } else {
                        this.showSignText(`Error: ${data.error}`);
                        this.showStatus(`Error: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    this.showSignText(`Error: ${error.message}`);
                    this.showStatus(`Error: ${error.message}`, 'error');
                });
            }

            displaySign(data) {
                console.log('displaySign called with:', data);
                console.log('sign_image value:', data.sign_image);
                
                if (data.sign_image) {
                    console.log('Setting image src to:', data.sign_image);
                    this.signImage.src = data.sign_image;
                    this.signImage.style.display = 'block';
                    this.signText.style.display = 'none';
                    console.log('Image element:', this.signImage);
                } else {
                    console.log('No sign_image found, showing text instead');
                    this.signImage.style.display = 'none';
                    this.signText.style.display = 'block';
                }

                const currentLang = this.languageSelect.value;
                
                let displayText;
                switch(currentLang) {
                    case 'hi-IN':
                        displayText = `à¤šà¤¿à¤¹à¥à¤¨: "${data.input_text}"`;
                        break;
                    case 'te-IN':
                        displayText = `à°¸à°‚à°•à±‡à°¤à°‚: "${data.input_text}"`;
                        break;
                    case 'ml-IN':
                        displayText = `à´šà´¿à´¹àµà´¨à´‚: "${data.input_text}"`;
                        break;
                    case 'ta-IN':
                        displayText = `à®•à¯à®±à®¿: "${data.input_text}"`;
                        break;
                    case 'kn-IN':
                        displayText = `à²šà²¿à²¹à³à²¨à³†: "${data.input_text}"`;
                        break;
                    case 'bn-IN':
                        displayText = `à¦šà¦¿à¦¹à§à¦¨: "${data.input_text}"`;
                        break;
                    case 'mr-IN':
                        displayText = `à¤šà¤¿à¤¨à¥à¤¹: "${data.input_text}"`;
                        break;
                    default:
                        displayText = `Sign: "${data.input_text}"`;
                }
                
                this.signText.textContent = displayText;
            }

            showSignText(text) {
                this.signText.textContent = text;
                this.signImage.style.display = 'none';
                this.signText.style.display = 'block';
            }

            // Voice output removed - now using voice INPUT for text-to-sign conversion
        }

        // Initialize both applications
        document.addEventListener('DOMContentLoaded', () => {
            new ISLDetector();
            new TextToSignConverter();
        });
    </script>
</body>
</html>